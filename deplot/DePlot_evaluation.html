<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Hands on DePlot</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="DePlot_evaluation_files/libs/clipboard/clipboard.min.js"></script>
<script src="DePlot_evaluation_files/libs/quarto-html/quarto.js"></script>
<script src="DePlot_evaluation_files/libs/quarto-html/popper.min.js"></script>
<script src="DePlot_evaluation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="DePlot_evaluation_files/libs/quarto-html/anchor.min.js"></script>
<link href="DePlot_evaluation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="DePlot_evaluation_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="DePlot_evaluation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="DePlot_evaluation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="DePlot_evaluation_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hands on DePlot</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>The DePlot authors describe their model as a ‘One-shot plot-to-table translation’ conversion module. This notebook explores DePlot’s image to structured text performance.</p>
<p>-Colin</p>
<section id="original-work" class="level2">
<h2 class="anchored" data-anchor-id="original-work">Original Work</h2>
<p>Source Paper: https://arxiv.org/abs/2212.10505<br>
Citation:</p>
<pre><code>@misc{liu2022deplot,
      title={DePlot: One-shot visual language reasoning by plot-to-table translation},
      author={Liu, Fangyu and Eisenschlos, Julian Martin and Piccinno, Francesco and Krichene, Syrine and Pang, Chenxi and Lee, Kenton and Joshi, Mandar and Chen, Wenhu and Collier, Nigel and Altun, Yasemin},
      year={2022},
      eprint={2212.10505},
      archivePrefix={arXiv},
      primaryClass={cs.CL}
}</code></pre>
<section id="limitations" class="level3">
<h3 class="anchored" data-anchor-id="limitations">Limitations</h3>
<ul>
<li>It is unknown how well DePlot can work for out-of-domain plot-to-text conversion. The authors suggest ‘a wider range of web charts can be used to gain a deeper understanding into DePlot’s robustness…’</li>
<li>DePlot does not work for graphics and images that do not have clear textual representations. For example, a diagram of a car part does not immediately have a tabular representation.</li>
<li>Orientation and color of visual objects are ignored.</li>
</ul>
</section>
<section id="ethics" class="level3">
<h3 class="anchored" data-anchor-id="ethics">Ethics</h3>
<p>The authors suggest any deployment have a filtering stage after generation. Data for training was generated or available via permissive licenses.</p>
</section>
</section>
<section id="hugging-face-transformers-model" class="level2">
<h2 class="anchored" data-anchor-id="hugging-face-transformers-model">Hugging Face Transformers Model</h2>
<p>This notebook uses the DePlot model as added to the Hugging Face ecosystem by <a href="https://huggingface.co/ybelkada">Younes Belkada</a>. It is available with examples at: https://github.com/huggingface/transformers</p>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>All execution times were measured using a Google Cloud Platform n1-standard-4 (4 vCPUs, 15 GB RAM) Vertex AI Notebook.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytesseract</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> textblob <span class="im">import</span> Word</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> multiprocessing.pool <span class="im">import</span> ThreadPool</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> StringIO</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image, ImageEnhance</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.cloud <span class="im">import</span> aiplatform</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vertexai.preview.language_models <span class="im">import</span> TextGenerationModel</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> Pix2StructProcessor, Pix2StructForConditionalGeneration</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Shared variables created in setup.ipynb</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>store <span class="op">-</span>r project_id</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>store <span class="op">-</span>r location_id</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Initialize AI Platform and Hugging Face model</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>aiplatform.init(project<span class="op">=</span>project_id, </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                location<span class="op">=</span>location_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>processor <span class="op">=</span> Pix2StructProcessor.from_pretrained(<span class="st">'google/deplot'</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Pix2StructForConditionalGeneration.from_pretrained(<span class="st">'google/deplot'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="i.-plot-with-value-labels" class="level2">
<h2 class="anchored" data-anchor-id="i.-plot-with-value-labels">I. Plot with Value Labels</h2>
<p>For a first example, let’s try a plot with values labeling each plot element.</p>
<p>The image:<br>
<img src="./data/5090.png" class="img-fluid"></p>
<p>First prediction:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>input_image <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"./data/5090.png"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>deplot_prompt <span class="op">=</span> <span class="st">"Generate underlying data table of the figure below"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>inputs <span class="op">=</span> processor(images<span class="op">=</span>input_image, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                   text<span class="op">=</span>deplot_prompt, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                   return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">512</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The model will output an undecoded tensor of results representing the structured text format. We’ll need to clean it to work with it further.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>predictions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>tensor([[    0, 43445,   789, 32349,  2649,   789,  1879,   284,   287,  2649,
           273,    27,   595,  3709, 32616,   789,   273,   285,   292,   274,
           278,   789,   273,   290,   290,   274,   278,   273,    27,  1389,
           789, 12701,   789,   273,   285,   290,   274,   278,   273,    27,
          2165,   789,   273,   289,   290,   274,   278,   789,   273,   289,
           292,   274,   278,   273,    27,  7217,   789,   273,   285,   295,
           274,   278,   789,   273,   290,   285,   274,   278,   273,    27,
         10883,   789,   273,   289,   279,   274,   278,   789,   273,   290,
           289,   274,   278,   273,    27,  1724,   789,   273,   285,   294,
           274,   278,   789,   273,   290,   290,   274,   278,   273,    27,
           854, 42872,  2340,   273,  9345,   287,   789,   273,   289,   278,
           274,   278,   789,   273,   290,   294,   274,   278,   273,    27,
          3682,   789,   273,   279,   292,   274,   278,   789,   273,   293,
           285,   274,   278,   273,    27,  3748,   789,   273,   279,   279,
           274,   278,   789,   273,   295,   289,   274,   278,     1]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> processor.decode(predictions[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>"Entity | Individuals responsibility | Government's responsibility &lt;0x0A&gt; MEDIAN | 39.0 | 55.0 &lt;0x0A&gt; Germany | nan | 35.0 &lt;0x0A&gt; UK | 45.0 | 49.0 &lt;0x0A&gt; Sweden | 37.0 | 53.0 &lt;0x0A&gt; Denmark | 42.0 | 54.0 &lt;0x0A&gt; France | 38.0 | 55.0 &lt;0x0A&gt; Netherla nns | 40.0 | 58.0 &lt;0x0A&gt; Spain | 29.0 | 63.0 &lt;0x0A&gt; Italy | 22.0 | 74.0"</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>proto_table <span class="op">=</span> output.replace(<span class="st">'&lt;0x0A&gt;'</span>, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>proto_table <span class="op">=</span> re.sub(<span class="vs">r'&lt;.*?&gt;'</span>, <span class="st">''</span>, proto_table)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(proto_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Entity | Individuals responsibility | Government's responsibility 
 MEDIAN | 39.0 | 55.0 
 Germany | nan | 35.0 
 UK | 45.0 | 49.0 
 Sweden | 37.0 | 53.0 
 Denmark | 42.0 | 54.0 
 France | 38.0 | 55.0 
 Netherla nns | 40.0 | 58.0 
 Spain | 29.0 | 63.0 
 Italy | 22.0 | 74.0</code></pre>
</div>
</div>
<p>Now let’s convert the <code>|</code> delimited table structure into a Pandas DataFrame. We’ll clean it a bit more too.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_table(StringIO(proto_table), sep<span class="op">=</span><span class="st">"|"</span>, header<span class="op">=</span><span class="dv">0</span>, skipinitialspace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The column titles have trailing whitespace, which can cause issues with fancy indexing in Pandas.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df.columns <span class="op">=</span> df.columns.<span class="bu">str</span>.strip()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first column of values is technically mixed types (String and Float) due to the ‘nan’ value. In this case we can cast the type to <code>float</code> and Pandas will infer that ‘nan’ should be a null value.</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> c <span class="kw">in</span> df.columns[<span class="dv">1</span>:]:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    df[c] <span class="op">=</span> df[c].astype(<span class="bu">float</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>df.dtypes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>Entity                          object
Individuals responsibility     float64
Government's responsibility    float64
dtype: object</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Individuals responsibility</th>
<th data-quarto-table-cell-role="th">Government's responsibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MEDIAN</td>
<td>39.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Germany</td>
<td>NaN</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>UK</td>
<td>45.0</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sweden</td>
<td>37.0</td>
<td>53.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Denmark</td>
<td>42.0</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>France</td>
<td>38.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Netherla nns</td>
<td>40.0</td>
<td>58.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Spain</td>
<td>29.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Italy</td>
<td>22.0</td>
<td>74.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>By visual inspection, we can see a couple of obvious errors in the model generated data:<br>
1. The column <code>Individuals responsibility</code> should have an appostrophy (<code>'</code>) and read as <code>Individual's responsibility</code>. As this is a column title and key to user understanding of the data, it’s a problematic error. 2. The value for the <code>Germany</code> row, <code>Individuals responsibility</code> column is <code>NaN</code> when in fact it should be 57. This kind of plot, called a mirrored bar chart, is labeled with text values that are not vertically aligned. The number 57 is the most out of alignment, which might have caused the model to ignore it. 3. The row title <code>Netherla nns</code> should be <code>Netherlands</code>. Inspecting the source image, there is a slight gap between the <code>a</code> and <code>n</code> in the word. This variablity might have again thrown the model off.</p>
<section id="output-plot" class="level3">
<h3 class="anchored" data-anchor-id="output-plot">Output Plot</h3>
<p>Let’s plot the output in a different format, just to complete a loopback from visual meaning to structured text and back to visual meaning.</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_plot <span class="op">=</span> df.copy()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>df_plot.index <span class="op">=</span> df_plot[<span class="st">'Entity'</span>]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>df_plot.plot.barh(xlabel<span class="op">=</span><span class="st">'% Respondants'</span>).<span class="op">\</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                  legend(loc<span class="op">=</span><span class="st">'lower right'</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.75</span>, <span class="dv">1</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-16-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="ii.-improve-plot-performance" class="level2">
<h2 class="anchored" data-anchor-id="ii.-improve-plot-performance">II. Improve Plot Performance</h2>
<p>Due to the errors in the initial prediction, let’s alter the image before prediction and see if the results are any better. Since we’re repeating work, let’s define some reusable methods.</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_d_structured(pil_image):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create structured data from an input image.</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">    pil_image : PIL.PngImagePlugin.PngImageFile, loaded image</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">        for structured text extraction</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">    proto_table : str, structured DePlot output with some cleaning</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    t0 <span class="op">=</span> pd.Timestamp(<span class="st">'now'</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    deplot_prompt <span class="op">=</span> <span class="st">"Generate underlying data table of the figure below"</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> processor(images<span class="op">=</span>pil_image, </span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>                       text<span class="op">=</span>deplot_prompt, </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>                       return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">512</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> processor.decode(predictions[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    proto_table <span class="op">=</span> output.replace(<span class="st">'&lt;0x0A&gt;'</span>, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    proto_table <span class="op">=</span> re.sub(<span class="vs">r'&lt;.*?&gt;'</span>, <span class="st">''</span>, proto_table)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> pd.Timestamp(<span class="st">'now'</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> t1<span class="op">-</span>t0</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dt, proto_table</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_2_df(pil_image):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a Pandas DataFrame from an input image.</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    pil_image : PIL.PngImagePlugin.PngImageFile, loaded image</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">        for structured text extraction</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">    dt : pandas._libs.tslibs.timedeltas.Timedelta, time elapsed</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">    _df : Pandas DataFrame, extracted data from plot</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    t0 <span class="op">=</span> pd.Timestamp(<span class="st">'now'</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    deplot_prompt <span class="op">=</span> <span class="st">"Generate underlying data table of the figure below"</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> processor(images<span class="op">=</span>pil_image, </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>                       text<span class="op">=</span>deplot_prompt, </span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>                       return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">512</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> processor.decode(predictions[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    proto_table <span class="op">=</span> output.replace(<span class="st">'&lt;0x0A&gt;'</span>, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    proto_table <span class="op">=</span> re.sub(<span class="vs">r'&lt;.*?&gt;'</span>, <span class="st">''</span>, proto_table)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#_df = pd.read_table(StringIO(proto_table), </span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                    sep="|", </span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                    header=0, </span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                    skipinitialspace=True)</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    _df <span class="op">=</span> pd.read_table(StringIO(proto_table), sep<span class="op">=</span><span class="st">"|"</span>)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    _df.columns <span class="op">=</span> _df.columns.<span class="bu">str</span>.strip()</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> pd.Timestamp(<span class="st">'now'</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> t1<span class="op">-</span>t0</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dt, _df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First, let’s rerun the original image:</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dt, df2 <span class="op">=</span> plot_2_df(input_image)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dt, input_image.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(Timedelta('0 days 00:01:48.051420'), (311, 478))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>df2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Individuals responsibility</th>
<th data-quarto-table-cell-role="th">Government's responsibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MEDIAN</td>
<td>39.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Germany</td>
<td>nan</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>UK</td>
<td>45.0</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sweden</td>
<td>37.0</td>
<td>53.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Denmark</td>
<td>42.0</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>France</td>
<td>38.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Netherla nns</td>
<td>40.0</td>
<td>58.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Spain</td>
<td>29.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Italy</td>
<td>22.0</td>
<td>74.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>input_image_bigger <span class="op">=</span> input_image.resize(np.array(input_image.size)<span class="op">*</span><span class="dv">3</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>input_image_bigger_sharp <span class="op">=</span> ImageEnhance.Sharpness(input_image_bigger).enhance(<span class="fl">1.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>dt, df3 <span class="op">=</span> plot_2_df(input_image_bigger)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>dt, input_image_bigger.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>(Timedelta('0 days 00:01:45.340896'), (933, 1434))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>df3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Individuals responsibility</th>
<th data-quarto-table-cell-role="th">Government's responsibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MEDIAN</td>
<td>39.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Germany</td>
<td>nan</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>UK</td>
<td>45.0</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sweden</td>
<td>37.0</td>
<td>53.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Denmark</td>
<td>42.0</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>France</td>
<td>38.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Netherla nns</td>
<td>40.0</td>
<td>58.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Spain</td>
<td>29.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Italy</td>
<td>22.0</td>
<td>74.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>dt, df4 <span class="op">=</span> plot_2_df(input_image_bigger_sharp)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>dt, input_image_bigger_sharp.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>(Timedelta('0 days 00:01:45.994349'), (933, 1434))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df4</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Individuals responsibility</th>
<th data-quarto-table-cell-role="th">Government's responsibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MEDIAN</td>
<td>39.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Germany</td>
<td>nan</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>UK</td>
<td>45.0</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sweden</td>
<td>37.0</td>
<td>53.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Denmark</td>
<td>42.0</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>France</td>
<td>38.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Netherla nns</td>
<td>40.0</td>
<td>58.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Spain</td>
<td>29.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Italy</td>
<td>22.0</td>
<td>74.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>So far, no change in performance or accuracy from a larger or ideally sharper edged text. Let’s try some other things, starting with a greyscale image since the authors say the model does not use color as input features.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>input_image.convert(<span class="st">'L'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<p><img src="DePlot_evaluation_files/figure-html/cell-26-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dt, df5 <span class="op">=</span> plot_2_df(input_image.convert(<span class="st">'L'</span>))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>Timedelta('0 days 00:01:49.847010')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Individual's responsibility</th>
<th data-quarto-table-cell-role="th">Government's responsibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MEDIAN</td>
<td>39.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Germany</td>
<td>nan</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>UK</td>
<td>45.0</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sweden</td>
<td>37.0</td>
<td>53.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Denmark</td>
<td>42.0</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>France</td>
<td>38.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Netherla nns</td>
<td>40.0</td>
<td>58.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Spain</td>
<td>29.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Italy</td>
<td>22.0</td>
<td>74.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>No change in performance or speed of prediction when the input is greyscale.</p>
<p>Let’s see how changing the horizontal and vertical scaling affects the model output.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>input_image.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>(311, 478)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>input_image.resize((<span class="dv">200</span>, <span class="dv">400</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<p><img src="DePlot_evaluation_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>dt, df6 <span class="op">=</span> plot_2_df(input_image.resize((<span class="dv">200</span>, <span class="dv">400</span>)))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>Timedelta('0 days 00:01:36.700854')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>df6</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Individuals responsibility</th>
<th data-quarto-table-cell-role="th">Government's responsibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MEDIAN</td>
<td>39.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Germany</td>
<td>57.0</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>UK</td>
<td>45.0</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sweden</td>
<td>nan</td>
<td>53.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Denmark</td>
<td>nan</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>France</td>
<td>38.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Netherlands</td>
<td>40.0</td>
<td>58.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Spain</td>
<td>29.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Italy</td>
<td>22.0</td>
<td>74.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Interestingly with the plot narrower, we get correctly spelled <code>Netherlands</code> and the Germany’s 57, but now miss the Sweden and Denmark values in the first column.</p>
<p>Let’s change the resize ratio in the other direction.</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>input_image.resize((<span class="dv">400</span>, <span class="dv">200</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<p><img src="DePlot_evaluation_files/figure-html/cell-33-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>dt, df7 <span class="op">=</span> plot_2_df(input_image.resize((<span class="dv">400</span>, <span class="dv">200</span>)))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>dt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>Timedelta('0 days 00:01:53.973501')</code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>df7</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Values</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2008</td>
<td>55</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2010</td>
<td>6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2011</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2012</td>
<td>8</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2013</td>
<td>9</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>2014</td>
<td>10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>2015</td>
<td>7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>2016</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>2017</td>
<td>40</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>2018</td>
<td>54</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>2019</td>
<td>30</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>2020</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>2021</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>2020</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>2019</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This is an unexpected result. The model seems to like numbers or features more vertically aligned than spread out - which perhaps makes sense since the goal is to output columnar data. Since this model result took so long to return, let’s add a timeout.</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> function_timeout(func, args, timeout):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Executes another function using multiprocessing but </span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co">    exits if more time than specified has elapsed.</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="co">    func : function, the function to execute</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co">    args : list, the arguments to pass to the function</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co">    timeout : int, the maximum time in seconds to allow the </span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co">        function to execute</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="co">    The return value of the input function</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> ThreadPool(processes<span class="op">=</span><span class="dv">1</span>) <span class="im">as</span> pool:</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        future <span class="op">=</span> pool.apply_async(func, args)</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> future.get(timeout)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> multiprocessing.<span class="pp">TimeoutError</span>:</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_2_df_timeout(pil_image, timeout<span class="op">=</span><span class="dv">180</span>):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a Pandas DataFrame from an input image.</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">    pil_image : PIL.PngImagePlugin.PngImageFile, loaded image</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">        for structured text extraction</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">    timeout : int, the maximum time in seconds to allow the </span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">        function to execute. Default is 180 (3 minutes).</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co">    dt : pandas._libs.tslibs.timedeltas.Timedelta, time elapsed</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="co">    _df : Pandas DataFrame, extracted data from plot</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> function_timeout(plot_2_df, [pil_image], timeout)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Timedelta(<span class="ss">f"</span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss"> s"</span>), <span class="va">None</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>dt, df2x <span class="op">=</span> plot_2_df_timeout(input_image)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>dt, input_image.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>(Timedelta('0 days 00:01:45.118023'), (311, 478))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>df2x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Individuals responsibility</th>
<th data-quarto-table-cell-role="th">Government's responsibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MEDIAN</td>
<td>39.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Germany</td>
<td>nan</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>UK</td>
<td>45.0</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sweden</td>
<td>37.0</td>
<td>53.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Denmark</td>
<td>42.0</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>France</td>
<td>38.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Netherla nns</td>
<td>40.0</td>
<td>58.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Spain</td>
<td>29.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Italy</td>
<td>22.0</td>
<td>74.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>df2.equals(df2x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>True</code></pre>
</div>
</div>
<p>Here we’ve confirmed we get the same result using the threaded timeout version as we got originally. Now we can experiment and not waste to much time.</p>
<p>Looking back at our results, the structured output from the narrower input image (<code>df6</code>) correctly captured some of the missing data in our original attempt (<code>df2</code>). Let’s try combining them as a kind of ‘average correct’.</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> type_selector(a, b):</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Select if both values can be represented at numeric"""</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(a)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(b)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'numeric'</span></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'string'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> not_na_selector(a, b):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Select the not-missing value"""</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> <span class="bu">float</span>(a)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> <span class="bu">float</span>(b)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isnull(a) <span class="op">&amp;</span> pd.notnull(b):</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> b</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pd.notnull(a) <span class="op">&amp;</span> pd.isnull(b):</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> a</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> pd.isnull(a) <span class="op">&amp;</span> pd.isnull(b):</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.NA</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> word_selector(a, b):</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    i <span class="op">=</span> []</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> Word(a)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    i.append(w.spellcheck()[<span class="dv">0</span>])</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> Word(b)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    i.append(w.spellcheck()[<span class="dv">0</span>])</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    _d <span class="op">=</span> <span class="bu">dict</span>(i)</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">max</span>(_d, key<span class="op">=</span>_d.get)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>_dfa <span class="op">=</span> df2.copy()</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>_dfb <span class="op">=</span> df6.copy()</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>df2_average <span class="op">=</span> df2.copy()</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>df_mask <span class="op">=</span> _dfa <span class="op">==</span> _dfb</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ix <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, df_mask.shape[<span class="dv">0</span>]):</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iy <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, df_mask.shape[<span class="dv">1</span>]):</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> df_mask.iloc[ix, iy] <span class="op">==</span> <span class="va">False</span>:</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>            a <span class="op">=</span> _dfa.iloc[ix, iy]</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>            b <span class="op">=</span> _dfb.iloc[ix, iy]</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>            target_type <span class="op">=</span> type_selector(a, b)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Target Type: </span><span class="sc">{</span>target_type<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> target_type <span class="op">==</span> <span class="st">'numeric'</span>:            </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>                c <span class="op">=</span> not_na_selector(a, b)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"numeric inputs: a: </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">, b: </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>                df2_average.iloc[ix, iy] <span class="op">=</span> c</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> target_type <span class="op">==</span> <span class="st">'string'</span>:</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"string Words: </span><span class="sc">{</span>a<span class="sc">}</span><span class="ss">, </span><span class="sc">{</span>b<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>                df2_average.iloc[ix, iy] <span class="op">=</span> word_selector(a, b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Target Type: numeric
numeric inputs: a:  nan , b:  57.0 
Target Type: numeric
numeric inputs: a:  37.0 , b:  nan 
Target Type: numeric
numeric inputs: a:  42.0 , b:  nan 
Target Type: string
string Words:  Netherla nns ,  Netherlands </code></pre>
</div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>df2_average</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Individuals responsibility</th>
<th data-quarto-table-cell-role="th">Government's responsibility</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MEDIAN</td>
<td>39.0</td>
<td>55.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Germany</td>
<td>57.0</td>
<td>35.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>UK</td>
<td>45.0</td>
<td>49.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Sweden</td>
<td>37.0</td>
<td>53.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Denmark</td>
<td>42.0</td>
<td>54.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>France</td>
<td>38.0</td>
<td>55.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Netherla nns</td>
<td>40.0</td>
<td>58.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Spain</td>
<td>29.0</td>
<td>63.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Italy</td>
<td>22.0</td>
<td>74.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Reviewing these results with the original input image, we have all the values correctly captured.</p>
<p>In summary, we used DePlot twice, once with the original image and once with the image compressed along the horizontal axis, then we replaced missing values where the two results overlapped and chose the strings that were spelled correctly.</p>
</section>
<section id="iii.-check-output-from-article" class="level2">
<h2 class="anchored" data-anchor-id="iii.-check-output-from-article">III. Check Output from Article</h2>
<p>In their article, the authors provide three plot images. Let’s see how accurate the model is at converting them.</p>
<p>Extracted image example image #1 (saved as <code>deplot_example_01.png</code>), from page 2: <img src="./data/deplot_example_01.png" class="img-fluid"></p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>example_01_image <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"./data/deplot_example_01.png"</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>dt, df_ex1 <span class="op">=</span> plot_2_df_timeout(example_01_image)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>dt, example_01_image.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>(Timedelta('0 days 00:00:45.009266'), (723, 507))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>df_ex1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">TITLE</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">models</td>
<td>augmented-set</td>
<td>human-set</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">VisionTapas</td>
<td>66</td>
<td>22</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Pix2Struct</td>
<td>82</td>
<td>30</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">MatCha</td>
<td>88</td>
<td>37</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">DePlot</td>
<td>91</td>
<td>67</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>example_1_str <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="st">models |augmented-set|human-set</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="st">VisionTapas |67.2 |22.2</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="st">Pix2Struct |82.9 |30.4</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="st">MatCha |89.0 |38.0</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="st">DePlot |91.0 |67.6"""</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>df_ex1_true <span class="op">=</span> pd.read_table(StringIO(example_1_str), sep<span class="op">=</span><span class="st">"|"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>df_ex1_true</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">models</th>
<th data-quarto-table-cell-role="th">augmented-set</th>
<th data-quarto-table-cell-role="th">human-set</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>VisionTapas</td>
<td>67.2</td>
<td>22.2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Pix2Struct</td>
<td>82.9</td>
<td>30.4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>MatCha</td>
<td>89.0</td>
<td>38.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>DePlot</td>
<td>91.0</td>
<td>67.6</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Close enough, although the header row is a bit off. Remember though, the author’s goal was input to an LLM so this is likely fine for that use case. Note though that the floating point accuracy of the plot has been lost, which will be reflected in any LLM application as well.</p>
<p>Source for the second example:<br>
<img src="./data/deplot_example_02.png" class="img-fluid"></p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>example_02_image <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"./data/deplot_example_02.png"</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>dt, df_ex2 <span class="op">=</span> plot_2_df_timeout(example_02_image)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>dt, example_02_image.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>(Timedelta('0 days 00:00:37.859238'), (1033, 778))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>df_ex2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Country</th>
<th data-quarto-table-cell-role="th">Share of marine territorial waters that are protected, 2016</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Greenland</td>
<td>4.52</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Mauritania</td>
<td>4.15</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Indonesia</td>
<td>2.88</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Ireland</td>
<td>2.33</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>example_2_str <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="st">country | protected-waters-percent</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="st">Greenland | 4.52</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="st">Mauritania | 4.15</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="st">Indonesia | 2.88</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="st">Ireland | 2.33"""</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>df_ex2_true <span class="op">=</span> pd.read_table(StringIO(example_2_str), sep<span class="op">=</span><span class="st">"|"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>df_ex2_true</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">country</th>
<th data-quarto-table-cell-role="th">protected-waters-percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Greenland</td>
<td>4.52</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Mauritania</td>
<td>4.15</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Indonesia</td>
<td>2.88</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Ireland</td>
<td>2.33</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This example is completely correct. The only difference are the column labels.</p>
<p>The third example:<br>
<img src="./data/deplot_example_03.png" class="img-fluid"></p>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>example_03_image <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"./data/deplot_example_03.png"</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>dt, df_ex3 <span class="op">=</span> plot_2_df_timeout(example_03_image)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>dt, example_03_image.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(Timedelta('0 days 00:01:26.759193'), (785, 811))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>example_3_str <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="st">Entity|Very concerned|Somewhat concerned|Not concerned</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a><span class="st">Children being exposed to harmful content| 79 | 14 | 6</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="st">Identity theft| 66 | 17 | 16</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="st">Exposure to false or incorrect information| 64 | 25 | 14</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a><span class="st">Mobile phone addiction| 62 | 17 | 18</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="st">Harassment or bullying| 59 | 21 | 16</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="st">Losing the ability to communicate face-to-face| 48 | 26 | 22"""</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>df_ex3_true <span class="op">=</span> pd.read_table(StringIO(example_3_str), sep<span class="op">=</span><span class="st">"|"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>df_ex3_true.columns = df_ex3_true.columns.str.strip()</p>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>df_ex3_true[<span class="st">'Entity'</span>] <span class="op">=</span> df_ex3_true[<span class="st">'Entity'</span>].<span class="bu">str</span>.strip()</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>df_ex3_true.sort_values(by<span class="op">=</span><span class="st">'Entity'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>df_ex3_true.reset_index(inplace<span class="op">=</span><span class="va">True</span>, drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>df_ex3[<span class="st">'Entity'</span>] <span class="op">=</span> df_ex3[<span class="st">'Entity'</span>].<span class="bu">str</span>.strip()</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>df_ex3.sort_values(by<span class="op">=</span><span class="st">'Entity'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>df_ex3.reset_index(inplace<span class="op">=</span><span class="va">True</span>, drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>df_ex3_true.equals(df_ex3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>True</code></pre>
</div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>df_ex3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Entity</th>
<th data-quarto-table-cell-role="th">Very concerned</th>
<th data-quarto-table-cell-role="th">Somewhat concerned</th>
<th data-quarto-table-cell-role="th">Not concerned</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Children being exposed to harmful content</td>
<td>79</td>
<td>14</td>
<td>6</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Exposure to false or incorrect information</td>
<td>64</td>
<td>25</td>
<td>14</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Harassment or bullying</td>
<td>59</td>
<td>21</td>
<td>16</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Identity theft</td>
<td>66</td>
<td>17</td>
<td>16</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Losing the ability to communicate face-to-face</td>
<td>48</td>
<td>26</td>
<td>22</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Mobile phone addiction</td>
<td>62</td>
<td>17</td>
<td>18</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>This result is correct too. One thing that the model seems to do though is return String values with whitespace padding on both sides. This might be an artifact of the structured data format parsing to Pandas. A string strip is sufficient to clean them up.</p>
</section>
<section id="iv.-other-plot-inputs" class="level2">
<h2 class="anchored" data-anchor-id="iv.-other-plot-inputs">IV. Other Plot Inputs</h2>
<p>Data Visualization can take a lot of forms.</p>
<p>Let’s try a plot that likely will not translate to structured data. Charles Minard’s map of Napolean’s Russian campaign of 1812 was described by Edward Tufte as what “may well be the best statistical graphic ever drawn”. An overview of Minard’s work is on Wikipedia:</p>
<p>https://en.wikipedia.org/wiki/Charles_Joseph_Minard</p>
<p>Edward Tufte has written extensively and is well worth reading:<br>
https://www.edwardtufte.com/tufte/</p>
<p><img src="./data/Charles_Minard_1869_Napolean_1812.png" class="img-fluid"></p>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>minard_image_01 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"./data/Charles_Minard_1869_Napolean_1812.png"</span>)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>dt, df_minard_01 <span class="op">=</span> plot_2_df_timeout(minard_image_01)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>dt, minard_image_01.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>(Timedelta('0 days 00:03:00'), (2003, 955))</code></pre>
</div>
</div>
<p>That didn’t end in 3 minutes, let’s give the model 20 minutes. That should be more than enough time to produce something. Also since we’re experimenting let’s just look at the structured string output. We’ll break the first function into two for more flexibility.</p>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_2_structured(pil_image):</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create structured data from an input image.</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">    pil_image : PIL.PngImagePlugin.PngImageFile, loaded image</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">        for structured text extraction</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="co">    proto_table : str, structured DePlot output with some cleaning</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>    t0 <span class="op">=</span> pd.Timestamp(<span class="st">'now'</span>)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>    deplot_prompt <span class="op">=</span> <span class="st">"Generate underlying data table of the figure below"</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>    inputs <span class="op">=</span> processor(images<span class="op">=</span>pil_image, </span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>                       text<span class="op">=</span>deplot_prompt, </span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>                       return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_new_tokens<span class="op">=</span><span class="dv">512</span>)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    output <span class="op">=</span> processor.decode(predictions[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    proto_table <span class="op">=</span> output.replace(<span class="st">'&lt;0x0A&gt;'</span>, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    proto_table <span class="op">=</span> re.sub(<span class="vs">r'&lt;.*?&gt;'</span>, <span class="st">''</span>, proto_table)</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> pd.Timestamp(<span class="st">'now'</span>)</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> t1<span class="op">-</span>t0</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dt, proto_table</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> structured_2_df(_proto_table):</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a Pandas DataFrame from a DePlot structured </span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co">    data output.</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">    _proto_table : str, structured data output from DePlot</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Pandas DataFrame, extracted data from plot</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>    _df <span class="op">=</span> pd.read_table(StringIO(_proto_table), sep<span class="op">=</span><span class="st">"|"</span>)</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    _df.columns <span class="op">=</span> _df.columns.<span class="bu">str</span>.strip()</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_2_df(pil_image):</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a Pandas DataFrame from an input image.</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="co">    pil_image : PIL.PngImagePlugin.PngImageFile, loaded image</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co">        for structured text extraction</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="co">    dt : pandas._libs.tslibs.timedeltas.Timedelta, time elapsed</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a><span class="co">    _df : Pandas DataFrame, extracted data from plot</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    t0 <span class="op">=</span> pd.Timestamp(<span class="st">'now'</span>)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>    _, proto_table <span class="op">=</span> plot_2_structured(pil_image)</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    _df <span class="op">=</span> structured_2_df(proto_table)</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    t1 <span class="op">=</span> pd.Timestamp(<span class="st">'now'</span>)</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>    dt <span class="op">=</span> t1<span class="op">-</span>t0</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> dt, _df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_2_structured_timeout(pil_image, timeout<span class="op">=</span><span class="dv">180</span>):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Create a Pandas DataFrame from an input image.</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="co">    pil_image : PIL.PngImagePlugin.PngImageFile, loaded image</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="co">        for structured text extraction</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="co">    timeout : int, the maximum time in seconds to allow the </span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a><span class="co">        function to execute. Default is 180 (3 minutes).</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a><span class="co">    dt : pandas._libs.tslibs.timedeltas.Timedelta, time elapsed</span></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co">    _df : Pandas DataFrame, extracted data from plot</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> function_timeout(plot_2_structured, [pil_image], timeout)</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Timedelta(<span class="ss">f"</span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss"> s"</span>), <span class="va">None</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># takes roughly 11 minutes</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>minard_image_01 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"./data/Charles_Minard_1869_Napolean_1812.png"</span>)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>dt, txt_minard_01 <span class="op">=</span> plot_2_structured_timeout(minard_image_01, timeout<span class="op">=</span><span class="dv">1200</span>)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>dt, minard_image_01.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>(Timedelta('0 days 00:17:52.237264'), (2003, 955))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_minard_01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
  | Kw
Rk. | M
G | GA
Yds 
 1. | 16.5 | 12.2 | 5.5 
 2. | 15.2 | 11.0 | 3.5 
 3. | 14.5 | 10.5 | 6.5 
 4. | 12.6 | 11.4 | 6.5 
 5. | 12.2 | 11.6 | 6.5 
 6. | 12.2 | 11.0 | 7.5 
 7. | 12.2 | 11.0 | 7.8 
 8. | 12.2 | 10.8 | 8.3 
 9. | 12.2 | 10.4 | 8.0 
 10. | 12.2 | 10.0 | 8.5 
 11. | 12.2 | 9.4 | 8.0 
 12. | 12.2 | 9.0 | 8.5 
 13. | 12.2 | 8.8 | 8.0 
 14. | 12.2 | 8.0 | 7.6 
 15. | 12.2 | 8.5 | 7.8 
 16. | 12.2 | 8.0 | 7.5 
 17. | 12.2 | 8.0 | 7.5 
 18. | 12.2 | 8.5 | 8.0 
 19. | 12.2 | 8.0 | 7.5 
 18. | 12.2 | 8.0 | 7.5 
 17. | 12.2 | 8.0 | 7.5 
 18. | 12.2 | 8.0 | 7.5 
 1</code></pre>
</div>
</div>
<p>The output is not at all what the original plot was representing, but we expected this. The ideal output might describe the army strength (size in people) as it relates to the distance traveled:</p>
<pre><code>distance | size
0 | 422,000
50 | 400,000
100 | 375,000
150 | 350,000
200 | 325,000</code></pre>
<p>Let’s try a well made modern graphic from the New York Times. This was captured from the article <code>‘Barbenheimer’ Weekend Was a Real Team Effort</code>, By Jason Karaian and Karl Russell and published July 24, 2023. Accessed online at: https://www.nytimes.com/2023/07/24/business/barbie-oppenheimer-weekend-box-office.html</p>
<p><img src="./data/nytime_2023_07_24_box_office.png" class="img-fluid"></p>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>karaian_russel_image_01 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"./data/nytime_2023_07_24_box_office.png"</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>dt, txt_karaian_russel_01 <span class="op">=</span> plot_2_structured_timeout(karaian_russel_image_01)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>dt, karaian_russel_image_01.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>(Timedelta('0 days 00:02:32.317687'), (774, 645))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_karaian_russel_01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE | Each top movie's share of weekend box Office Grosses
Year | Biggest Domestic Weekend Box Office Grosses
2010 | Biggest Domestic Weekend Box Office Grosses
2011 | Biggest Domestic Weekend Box Office Grosses
2012 
 July 24, 2023 | 2 | 1 
 By Jason Karaian and Karl Russell | 0 | 1 
 Source: Box Office Mojo | 0 | 1 
 April 26–28
2019 | 37 | 83 
 April 27–29
2018 | 253 | 32 
 Dec. 18–20
2015 | 313 | 31 
 July 21–23
2023 | 232 | 22</code></pre>
</div>
</div>
<p>This took about 2.5 minutes and came out looking well formatted but somewhat nonsensical. Extracting the most salient part and doing some manual reformatting:</p>
<pre><code> April 26–28 2019 | 37 | 83 
 April 27–29 2018 | 253 | 32 
 Dec. 18–20 2015 | 313 | 31 
 July 21–23 2023 | 232 | 22</code></pre>
<p>We can see the date ranges are accurately captured but the dollar values and percentages are not accurate. Let’s give the model less to work with and crop the image.</p>
<p>All surrounding data cropped:<br>
<img src="./data/nytime_2023_07_24_box_office_cropped.jpg" class="img-fluid"></p>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>karaian_russel_image_02 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"./data/nytime_2023_07_24_box_office_cropped.jpg"</span>)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>dt, txt_karaian_russel_02 <span class="op">=</span> plot_2_structured_timeout(karaian_russel_image_02)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>dt, karaian_russel_image_02.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>(Timedelta('0 days 00:01:02.548510'), (750, 368))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_karaian_russel_02)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
  | Charities 
 April 26–28
2019 | 402
million 
 April 27–29
2018 | 325.5 
 December 18–20
2015 | 324.5 
 July 21–23
2023 | 352.7</code></pre>
</div>
</div>
<p>This is an interesting observation since OCR has been very accurate for a long time. Let’s see what Tesseract, an open source OCR application, can do with the cropped image.</p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>fp_karaian_russel_cropped <span class="op">=</span> <span class="st">'data/nytime_2023_07_24_box_office_cropped.jpg'</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>img_karaian_russel_03 <span class="op">=</span> np.array(Image.<span class="bu">open</span>(fp_karaian_russel_cropped))</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>txt_karaian_russel_03 <span class="op">=</span> pytesseract.image_to_string(img_karaian_russel_03)</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_karaian_russel_03)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>July 21-23
2023

Dec. 18-20
2015

April 27-29
2018

April 26-28
2019

$311
million

$313
million

$314
million

$402
million
</code></pre>
</div>
</div>
<p>That’s closer to what we’re looking for. The dates and dollar values are correct. Tesseract supports much more than this simple example. It has a long development history and is currently developed by Google. Read more here:<br>
https://github.com/tesseract-ocr/tesseract</p>
</section>
<section id="v.-generated-plot-data" class="level2">
<h2 class="anchored" data-anchor-id="v.-generated-plot-data">V. Generated Plot Data</h2>
<p>Let’s make some plots with data we know is structured. That way any errors in DePlot output are an artifact of the model performance.</p>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>dfx <span class="op">=</span> pd.DataFrame({<span class="st">'a'</span>:[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>],</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'b'</span>:[<span class="dv">4</span>,<span class="dv">5</span>,<span class="dv">6</span>]},</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>                   index<span class="op">=</span>[<span class="st">'this'</span>, <span class="st">'that'</span>, <span class="st">'other'</span>])</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>dfx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">a</th>
<th data-quarto-table-cell-role="th">b</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">this</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">that</td>
<td>2</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">other</td>
<td>3</td>
<td>6</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> dfx.plot.bar()</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> container <span class="kw">in</span> ax.containers:</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    ax.bar_label(container, padding<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'data/_temp.png'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-73-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>gen_image_01 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>dt, txt_gen_image_01 <span class="op">=</span> plot_2_structured_timeout(gen_image_01)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>dt, gen_image_01.size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>(Timedelta('0 days 00:00:26.217748'), (640, 480))</code></pre>
</div>
</div>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_gen_image_01)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
  | a | b 
 this | 1 | 4 
 that | 2 | 5 
 other | 3 | 6</code></pre>
</div>
</div>
<p>Pretty good, let’s compare it to tesseract.</p>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>tesseract_array <span class="op">=</span> np.array(Image.<span class="bu">open</span>(<span class="st">'./data/_temp.png'</span>))</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>txt_tesseract_temp <span class="op">=</span> pytesseract.image_to_string(tesseract_array)</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_tesseract_temp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> 

 

 

 

 

 

0

4eun0
</code></pre>
</div>
</div>
<p>Pretty much nothing out from tesseract OCR. Let’s try some more configurations of this plot.</p>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> dfx.plot.bar()</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="co">#for container in ax.containers:</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="co">#    ax.bar_label(container, padding=5)</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'data/_temp.png'</span>)</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>gen_image_02 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>dt, txt_gen_image_02 <span class="op">=</span> plot_2_structured_timeout(gen_image_02)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>dt, gen_image_02.size</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_gen_image_02)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
  | a | b 
 this | 1 | 4 
 that | 2 | 5 
 other | 3 | 6</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-77-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>structured_2_df(txt_gen_image_02)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">TITLE</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th"></td>
<td>a</td>
<td>b</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">this</td>
<td>1</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">that</td>
<td>2</td>
<td>5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">other</td>
<td>3</td>
<td>6</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now this is getting interesting. This time, the model was able to convert the plot to data without data labels. That is, it read the axis and inferred values spatially between the graphical entities of the plot. It continues to be inconsistent in header and table formatting which would be a challenge to generalize handling in a data pipeline.</p>
<div class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> dfx.plot.pie(y<span class="op">=</span><span class="st">'a'</span>, legend<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'data/_temp.png'</span>)</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>gen_image_03 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>dt, txt_gen_image_03 <span class="op">=</span> plot_2_structured_timeout(gen_image_03)</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>dt, gen_image_03.size</span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_gen_image_03)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
 a | nan 
 this | nan 
 that | nan</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-79-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Pie charts don’t work. Which is fine, we shouldn’t be <a href="https://scc.ms.unimelb.edu.au/resources/data-visualisation-and-exploration/no_pie-charts">using them anyway</a>.</p>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.heatmap(dfx)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'data/_temp.png'</span>)</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>gen_image_04 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>)</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>dt, txt_gen_image_04 <span class="op">=</span> plot_2_structured_timeout(gen_image_04)</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>dt, gen_image_04.size</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_gen_image_04)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
 other |  
 a | 6 
 b | 0 
 c | 1</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-80-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>So this is interesting, not that the model halicinated the value 0, it appears nowhere on the chart. The only similar character is the ‘o’ in other, which is already returned as a column title.</p>
<div class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.heatmap(dfx, annot<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'data/_temp.png'</span>)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>gen_image_05 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>dt, txt_gen_image_05 <span class="op">=</span> plot_2_structured_timeout(gen_image_05)</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>dt, gen_image_05.size</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_gen_image_05)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
  | 1 
 a | 3 
 b | 6 
 c | 2</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-81-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>With annotations, some of the data is represented. Perhaps the model selected data along a path in the bottom row (other). Nothing concrete, this kind of data output would be hard to programatically extract from new plots.</p>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.heatmap(dfx, annot<span class="op">=</span><span class="va">True</span>, cbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'data/_temp.png'</span>)</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>gen_image_06 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>)</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>dt, txt_gen_image_06 <span class="op">=</span> plot_2_structured_timeout(gen_image_06)</span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>dt, gen_image_06.size</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_gen_image_06)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
 other | 3 
 a | 3 
 b | 6</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-82-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>This is still not capturing the data, which is disappointing since this is about as rectilinearly structured a data plot as we could get. Let’s try reconfiguring the heatmap a bit, perhaps something will come out more clearly.</p>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> sns.heatmap(dfx, annot<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>                 xticklabels<span class="op">=</span><span class="va">False</span>, yticklabels<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>                 cbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> ax.get_figure()</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>fig.savefig(<span class="st">'data/_temp.png'</span>)</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>gen_image_07 <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>)</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>dt, txt_gen_image_07 <span class="op">=</span> plot_2_structured_timeout(gen_image_07)</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>dt, gen_image_07.size</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt_gen_image_07)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>TITLE |  
  | 4 
 1 | 1 
 2 | 2 
 3 | 3 
 4 | 5</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-83-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>No luck, also where the sequence <code>1,2,3,5</code> came from is puzzling. Let’s double check with OCR.</p>
<div class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>img2 <span class="op">=</span> np.array(Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>))</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> pytesseract.image_to_string(img2)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>' \n\x0c'</code></pre>
</div>
</div>
<p>Even worse. Let’s resize the heatmap.</p>
<div class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> figure_2_txt(fig):</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    fig.savefig(<span class="st">'data/_temp.png'</span>)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    _gen_image <span class="op">=</span> Image.<span class="bu">open</span>(<span class="st">"data/_temp.png"</span>)</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    dt, _txt_gen_image <span class="op">=</span> plot_2_structured_timeout(_gen_image)</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Time elapsed: </span><span class="sc">{</span>dt<span class="sc">}</span><span class="ss">, size of image: </span><span class="sc">{</span>_gen_image<span class="sc">.</span>size<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> _txt_gen_image</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>sns.heatmap(dfx, annot<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>            xticklabels<span class="op">=</span><span class="va">False</span>, yticklabels<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>            cbar<span class="op">=</span><span class="va">False</span>, ax<span class="op">=</span>ax)</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>txt <span class="op">=</span> figure_2_txt(ax.get_figure())</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time elapsed: 0 days 00:00:27.818837, size of image: (300, 300)
TITLE |  
  | 4 
 1 | 1 
 2 | 2 
 3 | 5 
 4 | 4</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-86-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>sns.heatmap(dfx, annot<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>            xticklabels<span class="op">=</span><span class="va">False</span>, yticklabels<span class="op">=</span><span class="va">False</span>, </span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>            cbar<span class="op">=</span><span class="va">False</span>, ax<span class="op">=</span>ax)</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>txt <span class="op">=</span> figure_2_txt(ax.get_figure())</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time elapsed: 0 days 00:00:22.067365, size of image: (100, 100)
TITLE |  
  | 3 | 5 
 | 2 | 5 
 | 1 | 4</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-87-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>This result is mostly correct. And it follows a pattern that other results have taken which is the rows are returned in reverse sorted order from their top to bottom location in the plot.</p>
<div class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>sns.heatmap(dfx, annot<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>            xticklabels<span class="op">=</span><span class="va">True</span>, yticklabels<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>            cbar<span class="op">=</span><span class="va">False</span>, ax<span class="op">=</span>ax)</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>txt <span class="op">=</span> figure_2_txt(ax.get_figure())</span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(txt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time elapsed: 0 days 00:00:51.863724, size of image: (100, 100)
TITLE |  
  | AFC Central
T | AFC Central
W | AFC Central
L | AFC Central
PA 
 (1) | 3 | 2 | 5 | 6 
 (4) | 2 | 1 | 5 | 5 
 (5) | 0 | 0 | 1 | 4</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="DePlot_evaluation_files/figure-html/cell-88-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>This result is worse than useless; it’s actively inserting uncertainty into the analysis by returning content that is not present in the input image (all of the <code>AFC Central</code> labels, plus the shape mismatch of the input and output).</p>
</section>
<section id="vi.-conclusions" class="level2">
<h2 class="anchored" data-anchor-id="vi.-conclusions">VI. Conclusions</h2>
<p>In limited situations, DePlot is able to generate structured data from charts and plots. As trained by the authors, the model is not sufficiently accurate to be used in a production data pipeline.</p>
<p>The authors of DePlot evaluated their model performance using two published datasets: <code>ChartQA</code> and <code>PlotQA</code> at 1/3 each and the last 1/3 their own annotated data. Clearly further fine-tuning would be required on a specific domain before DePlot is ready for an application specific deployment. Indeed, the authors state:</p>
<pre><code>To obtain effective plot-to-text conversion, large amounts of diverse and in-domain plot-table parallel data are usually needed. It is unknown to which extent DEPLOT can work for out-of-domain (OOD) plotto text conversion. We investigated this in section §6.2 but in the future a wider range of web charts can be used to gain a deeper understanding into DEPLOT’s robustness for OOD plots</code></pre>
<p>A limitation of this Notebook study is that we have potentially evaluated the model out-of-domain. The authors state <code>DEPLOT is conceptually simple yet can robustly work for all types of charts (line, dot, bar, and pie charts)</code> - which does not include stacked bar charts, heatmaps or anything like Minard’s map.</p>
<p>Next steps could be finding an application specific domain and training DePlot on just that application and evaluating performance.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>